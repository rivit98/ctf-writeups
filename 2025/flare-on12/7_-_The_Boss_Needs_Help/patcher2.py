import itertools
import json
import re
import sys
import shutil
from multiprocessing import Pool

import pefile
from capstone import Cs, CS_ARCH_X86, CS_MODE_32, CS_MODE_64
from capstone.x86_const import *


from capstone.x86_const import *

REG_FAMILIES = {
    # RAX family
    X86_REG_AL:  X86_REG_RAX,
    X86_REG_AH:  X86_REG_RAX,
    X86_REG_AX:  X86_REG_RAX,
    X86_REG_EAX: X86_REG_RAX,
    X86_REG_RAX: X86_REG_RAX,

    # RBX family
    X86_REG_BL:  X86_REG_RBX,
    X86_REG_BH:  X86_REG_RBX,
    X86_REG_BX:  X86_REG_RBX,
    X86_REG_EBX: X86_REG_RBX,
    X86_REG_RBX: X86_REG_RBX,

    # RCX family
    X86_REG_CL:  X86_REG_RCX,
    X86_REG_CH:  X86_REG_RCX,
    X86_REG_CX:  X86_REG_RCX,
    X86_REG_ECX: X86_REG_RCX,
    X86_REG_RCX: X86_REG_RCX,

    # RDX family
    X86_REG_DL:  X86_REG_RDX,
    X86_REG_DH:  X86_REG_RDX,
    X86_REG_DX:  X86_REG_RDX,
    X86_REG_EDX: X86_REG_RDX,
    X86_REG_RDX: X86_REG_RDX,

    # RSI family
    X86_REG_SIL:  X86_REG_RSI,
    X86_REG_SI:   X86_REG_RSI,
    X86_REG_ESI:  X86_REG_RSI,
    X86_REG_RSI:  X86_REG_RSI,

    # RDI family
    X86_REG_DIL:  X86_REG_RDI,
    X86_REG_DI:   X86_REG_RDI,
    X86_REG_EDI:  X86_REG_RDI,
    X86_REG_RDI:  X86_REG_RDI,

    # RBP family
    X86_REG_BPL:  X86_REG_RBP,
    X86_REG_BP:   X86_REG_RBP,
    X86_REG_EBP:  X86_REG_RBP,
    X86_REG_RBP:  X86_REG_RBP,

    # RSP family
    X86_REG_SPL:  X86_REG_RSP,
    X86_REG_SP:   X86_REG_RSP,
    X86_REG_ESP:  X86_REG_RSP,
    X86_REG_RSP:  X86_REG_RSP,

    # R8–R15 families
    X86_REG_R8B:  X86_REG_R8,
    X86_REG_R8W:  X86_REG_R8,
    X86_REG_R8D:  X86_REG_R8,
    X86_REG_R8:   X86_REG_R8,

    X86_REG_R9B:  X86_REG_R9,
    X86_REG_R9W:  X86_REG_R9,
    X86_REG_R9D:  X86_REG_R9,
    X86_REG_R9:   X86_REG_R9,

    X86_REG_R10B: X86_REG_R10,
    X86_REG_R10W: X86_REG_R10,
    X86_REG_R10D: X86_REG_R10,
    X86_REG_R10:  X86_REG_R10,

    X86_REG_R11B: X86_REG_R11,
    X86_REG_R11W: X86_REG_R11,
    X86_REG_R11D: X86_REG_R11,
    X86_REG_R11:  X86_REG_R11,

    X86_REG_R12B: X86_REG_R12,
    X86_REG_R12W: X86_REG_R12,
    X86_REG_R12D: X86_REG_R12,
    X86_REG_R12:  X86_REG_R12,

    X86_REG_R13B: X86_REG_R13,
    X86_REG_R13W: X86_REG_R13,
    X86_REG_R13D: X86_REG_R13,
    X86_REG_R13:  X86_REG_R13,

    X86_REG_R14B: X86_REG_R14,
    X86_REG_R14W: X86_REG_R14,
    X86_REG_R14D: X86_REG_R14,
    X86_REG_R14:  X86_REG_R14,

    X86_REG_R15B: X86_REG_R15,
    X86_REG_R15W: X86_REG_R15,
    X86_REG_R15D: X86_REG_R15,
    X86_REG_R15:  X86_REG_R15,
}

def normalize_reg(reg_id):
    """Map any GPR subregister to its canonical 64-bit register."""
    return REG_FAMILIES.get(reg_id, reg_id)


def find_text_section(pe):
    for s in pe.sections:
        name = s.Name.rstrip(b'\x00')
        if name == b'.text':
            return s
    return None

def build_iat_addresses(pe):
    addrs = set()
    if not hasattr(pe, "DIRECTORY_ENTRY_IMPORT"):
        return addrs
    for imp in pe.DIRECTORY_ENTRY_IMPORT:
        for entry in imp.imports:
            if entry.address:
                addrs.add(entry.address)
    return addrs

def va_to_rva(pe, va):
    return va - pe.OPTIONAL_HEADER.ImageBase

def rva_to_file_offset(pe, rva):
    return pe.get_offset_from_rva(rva)


def worker(arg):
    dst_path, bad_movs, func_data = arg

    # make a copy to patch
    pe = pefile.PE(dst_path, fast_load=True)
    sec = find_text_section(pe)

    md = Cs(CS_ARCH_X86, CS_MODE_64)
    md.detail = True

    text_rva = sec.VirtualAddress
    image_base = pe.OPTIONAL_HEADER.ImageBase
    text_va = image_base + text_rva
    data = sec.get_data()

    to_patch = []

    def patch(insn):
        to_patch.append((insn.address, va_to_rva(pe, insn.address), insn.size))

    for func_start, mov, mov_size in [bad_movs]:
        func_mov = func_start - text_va
        instrs = list(md.disasm(data[func_mov:mov+mov_size], func_start))
        print(f"mov: {text_va+mov:#x} func_start: {func_start:#x} func_mov: {func_mov:#x} instrs: {len(instrs)}")

        poisoned = set()
        prev_insn = None
        # now lets do the patching by figuring out useless instructions
        # for idx, insn in enumerate(reversed(instrs[-600:])):
        for idx, insn in enumerate(reversed(instrs)):
            poisoned.discard(X86_REG_RIP)
            poisoned.discard(X86_REG_EFLAGS)

            (address, size, mnemonic, op_str) = (insn.address, insn.size, insn.mnemonic, insn.op_str)
            regs_read, regs_write = insn.regs_access()
            regs_read = set(map(normalize_reg, regs_read))
            regs_write = set(map(normalize_reg, regs_write))
            rr = ', '.join(map(lambda r: insn.reg_name(r), regs_read))
            rw = ', '.join(map(lambda r: insn.reg_name(r), regs_write))
            operands = insn.operands

            # if address < 0x14000f248: break

            print('---')
            print(f'{hex(address)}: {mnemonic} {op_str}   | rr: {rr} ; rw: {rw} | operands {len(operands)}')
            print("poisoned regs:", ', '.join(map(lambda r: md.reg_name(r), filter(lambda r: isinstance(r, int), poisoned))))
            print("poisoned locals:", ', '.join(map(str, filter(lambda r: not isinstance(r, int), poisoned))))

            # if we se a compare just before our jump
            if mnemonic in ('cmp', 'test') and prev_insn is not None:
                operands = prev_insn.operands
                if X86_GRP_JUMP in prev_insn.groups:
                    # try to remove jump if jumps close to current rip
                    if op.type == X86_OP_IMM:
                        if abs(op.imm - (prev_insn.address + prev_insn.size)) < 0x20:
                            patch(prev_insn)
                            continue

                prev_insn = None


            if len(operands) == 0:
                if mnemonic in ('cdq', ):
                    if {X86_REG_RAX, X86_REG_RDX} & poisoned:
                        patch(insn)
                        continue

                continue

            elif len(operands) == 1:
                op = operands[0]

                if X86_GRP_JUMP in insn.groups:
                    # try to remove jump if jumps close to current rip
                    if op.type == X86_OP_IMM:
                        prev_insn = insn
                        # if abs(op.imm - (insn.address + insn.size)) < 0x20:
                        #     patch(insn)
                        #     continue


                # single operand instructions do not change poison state
                if mnemonic in ('dec', 'inc', 'not', 'neg'):
                    if op.type == X86_OP_REG and normalize_reg(op.reg) in poisoned:
                        patch(insn)
                        continue

                # rdx, rax are poisoned afterwards
                elif mnemonic in ('idiv', ):
                    if op.type == X86_OP_REG and {normalize_reg(op.reg), X86_REG_RAX, X86_REG_RDX   } & poisoned:
                        # idiv rax, rdx are poisoned afterwards
                        poisoned.add(X86_REG_RAX)
                        poisoned.add(X86_REG_RDX)
                        patch(insn)
                        continue
                elif mnemonic in ('imul', ):
                    if op.type == X86_OP_REG and normalize_reg(op.reg) in poisoned:
                        patch(insn)
                        continue

                continue

            op1, op2 = operands[0], operands[1]
            mem_op1, mem_op2 = op1.mem if op1.type == X86_OP_MEM else None, op2.mem if op2.type == X86_OP_MEM else None

            if mem_op1:
                mem_op1 = (mem_op1.base, mem_op1.index, mem_op1.scale, mem_op1.disp)
                print(f"mem_op1: {mem_op1}")
            if mem_op2:
                mem_op2 = (mem_op2.base, mem_op2.index, mem_op2.scale, mem_op2.disp)
                print(f"mem_op2: {mem_op2}")

            if idx == 0:
                # first instruction is always bad
                poisoned.update(regs_read)
                patch(insn)
                continue

            if op1.type == X86_OP_REG:
                op1reg = normalize_reg(op1.reg)
                if op2.type == X86_OP_REG:
                    op2reg = normalize_reg(op2.reg)
                    if op1reg in poisoned:
                        poisoned.add(op2reg)
                        if not (op1reg in regs_read and op1reg in regs_write):
                            poisoned.discard(op1reg)
                        patch(insn)
                        continue

                elif op2.type == X86_OP_MEM:
                    if op1reg in poisoned:
                        poisoned.add(mem_op2)
                        if not (op1reg in regs_read and op1reg in regs_write):
                            poisoned.discard(op1reg)
                        patch(insn)
                        continue
                elif op2.type == X86_OP_IMM:
                    if op1reg in poisoned:
                        if not (op1reg in regs_read and op1reg in regs_write):
                            poisoned.discard(op1reg)
                        patch(insn)
                        continue
                    elif op2.imm > 0x10000000: # 2C42B17F
                        patch(insn)
                        continue
                else:
                    raise ValueError("unknown op2 type")
            elif op1.type == X86_OP_MEM:
                if op2.type == X86_OP_REG:
                    op2reg = normalize_reg(op2.reg)
                    if mem_op1 in poisoned:
                        poisoned.add(op2reg)
                        poisoned.discard(mem_op1)
                        patch(insn)
                        continue

                elif op2.type == X86_OP_MEM:
                    if mem_op1 in poisoned:
                        poisoned.add(mem_op2)
                        poisoned.discard(mem_op1)
                        patch(insn)
                        continue

                elif op2.type == X86_OP_IMM:
                    if mem_op1 in poisoned:
                        poisoned.discard(mem_op1)
                        patch(insn)
                        continue

                else:
                    raise ValueError(f"unknown op2 type: {op2.type}")

            else:
                raise ValueError("unknown op1 type")

            print("no poison action")

        # break

    return to_patch

def main(src_path, dst_path):
    with open("./hopeanddreams.exe_functions.json", "rb") as f:
        func_data = json.load(f)

    shutil.copy2(src_path, dst_path)

    pe = pefile.PE(dst_path, fast_load=True)
    sec = find_text_section(pe)

    md = Cs(CS_ARCH_X86, CS_MODE_64)
    md.detail = True

    text_rva = sec.VirtualAddress
    image_base = pe.OPTIONAL_HEADER.ImageBase
    text_va = image_base + text_rva
    data = sec.get_data()

    """
mov dword ptr [rip + 0x459257], eax
89 05 57924500

mov dword ptr [rip + 0x1d6ac3], ecx
89 0d C36A1D00
    """
    movs = [
        off
        for off in range(len(data))
        if data[off:off+1] == b'\x89'
    ]

    print(f"Found {len(movs)} bad movs")

    """
    .data:000000014047A3AC dword_14047A3AC dd ?                    ; DATA XREF: sub_14000D8E0+3C43↑w
    .data:000000014047A3B0 dword_14047A3B0 dd ?                    ; DATA XREF: sub_14000D8E0+37↑r
    .data:000000014047A3B4 dword_14047A3B4 dd ?                    ; DATA XREF: sub_14000D8E0+1E3D↑w
    """

    bad_endings = [
        0x14047A3AC,
        0x14047A3B0,
        0x14047A3B4,
    ]

    bad_movs = []
    for mov in movs:
        for insn in md.disasm(data[mov:mov+0x100], text_va+mov, count=1):
            (address, size, mnemonic, op_str) = (insn.address, insn.size, insn.mnemonic, insn.op_str)
            if 'rip' not in op_str:
                continue
            m = re.search(r'(0x[0-9a-fA-F]+)', op_str)
            resolved_dest = address + int(m.group(1),16) + size  # → 0x4792f6
            # print(f'mov: {mov:#x} | {hex(address)}: {mnemonic} {op_str} -> resolved_dest={resolved_dest:#x}')

            if resolved_dest in bad_endings:
                # print(f'mov: {mov:#x} | {hex(address)}: {mnemonic} {op_str} -> resolved_dest={resolved_dest:#x}')

                funcs_containing_mov = [
                    f_data['start']
                    for f_data in func_data
                    if f_data['start'] <= text_va+mov < f_data['end']
                ]
                funcs_containing_mov = set(funcs_containing_mov)
                if len(funcs_containing_mov) != 1:
                    raise ValueError(f"Skipping mov {text_va+mov:#x}, not in any function")

                func_start = list(funcs_containing_mov)[0]
                bad_movs.append((func_start, mov, size))

    print(bad_movs)
    # exit(0)

    bad_movs = bad_movs_forced

    print(f"Found {len(bad_movs)} bad movs")
    bad_movs = sorted(bad_movs, key=lambda x: x[0], reverse=True)

    to_patch = []
    with Pool(8) as p:
        for patches in p.imap(worker, [(dst_path, b, func_data) for b in bad_movs], chunksize=1):
            to_patch.extend(patches)

    # return
    with open(dst_path, "r+b") as f:
        for addr, rva, size in to_patch:
            file_off = rva_to_file_offset(pe, rva)
            # print(f"Patching VA 0x{addr:x} (file offset 0x{file_off:x}) size {size}")
            f.seek(file_off)
            f.write(b'\x90' * size)  # NOP each byte


if __name__ == "__main__":
    bad_movs_forced = [(5368764640, 59165, 6), (5368764640, 66851, 6), (5368764640, 67194, 6), (5368764640, 67316, 6), (5368764640, 67764, 6), (5368781088, 75610, 6), (5368781088, 83390, 6), (5368781088, 91067, 6), (5368804464, 98980, 6), (5368804464, 106877, 6), (5368804464, 114598, 6), (5368804464, 122837, 6), (5368836800, 131415, 6), (5368836800, 139306, 6), (5368836800, 147278, 6), (5368861360, 156173, 6), (5368861360, 164283, 6), (5368861360, 172114, 6), (5368885616, 180724, 6), (5368897568, 185194, 6), (5368897568, 185282, 6), (5368897568, 185523, 6), (5368897568, 185687, 6), (5368897568, 185887, 6), (5368897568, 185907, 6), (5368897568, 193901, 6), (5368897568, 201893, 6), (5368915536, 210273, 6), (5368915536, 210644, 6), (5368915536, 210732, 6), (5368915536, 210973, 6), (5368915536, 211137, 6), (5368915536, 211337, 6), (5368915536, 211357, 6), (5368924624, 219352, 6), (5368924624, 219745, 6), (5368924624, 220273, 6), (5368933616, 220691, 6), (5368933616, 220759, 6), (5368933616, 220942, 6), (5368933616, 221074, 6), (5368933616, 221230, 6), (5368933616, 221255, 6), (5368934544, 221854, 6), (5368934544, 222059, 6), (5368934544, 222136, 6), (5368935376, 230165, 6), (5368935376, 238152, 6), (5368935376, 246391, 6), (5368960416, 255271, 6), (5368960416, 255904, 6), (5368960416, 256145, 6), (5368960416, 256238, 6), (5368960416, 264038, 6), (5368960416, 264367, 6), (5368960416, 264489, 6), (5368960416, 264917, 6), (5368960416, 272668, 6), (5368960416, 280652, 6), (5368960416, 288607, 6), (5368960416, 296559, 6), (5368960416, 297385, 6), (5368960416, 305409, 6), (5368960416, 305707, 6), (5368960416, 306108, 6), (5368960416, 306187, 6), (5368960416, 306205, 6), (5368960416, 314023, 6), (5368960416, 322194, 6), (5368960416, 323252, 6), (5369040480, 335276, 6), (5369040480, 343107, 6), (5369056336, 351074, 6), (5369056336, 358893, 6), (5369072128, 366912, 6), (5369072128, 374639, 6), (5369072128, 374766, 6), (5369072128, 374946, 6), (5369072128, 375218, 6), (5369072128, 375396, 6), (5369072128, 375588, 6), (5369072128, 383308, 6), (5369096592, 391391, 6), (5369096592, 399474, 6), (5369096592, 407482, 6), (5369096592, 407763, 6), (5369096592, 407831, 6), (5369096592, 408014, 6), (5369096592, 408146, 6), (5369096592, 408302, 6), (5369096592, 408320, 6), (5369096592, 416166, 6), (5369129888, 424582, 6), (5369129888, 432381, 6), (5369129888, 432496, 6), (5369129888, 432646, 6), (5369129888, 432884, 6), (5369129888, 433034, 6), (5369129888, 433213, 6), (5369129888, 441191, 6), (5369129888, 441520, 6), (5369129888, 441642, 6), (5369129888, 442070, 6), (5369129888, 450206, 6), (5369129888, 458323, 6), (5369129888, 466065, 6), (5369129888, 474022, 6), (5369129888, 481977, 6), (5369129888, 482805, 6), (5369196384, 491183, 6), (5369196384, 499377, 6), (5369196384, 507509, 6), (5369196384, 508142, 6), (5369196384, 508383, 6), (5369196384, 508486, 6), (5369196384, 516297, 6), (5369196384, 516690, 6), (5369196384, 517218, 6), (5369196384, 525011, 6), (5369238928, 538451, 6), (5369238928, 551253, 6), (5369238928, 564070, 6), (5369238928, 565149, 6), (5369238928, 577945, 6), (5369238928, 591275, 6), (5369238928, 604149, 6), (5369238928, 617462, 6), (5369238928, 617875, 6), (5369238928, 618391, 6), (5369238928, 618490, 6), (5369238928, 618513, 6), (5369238928, 632125, 6), (5369238928, 632211, 6), (5369238928, 632992, 6), (5369238928, 646188, 6), (5369238928, 659799, 6), (5369238928, 672904, 6), (5369238928, 686250, 6), (5369238928, 686854, 6), (5369238928, 687076, 6), (5369238928, 687190, 6), (5369238928, 700846, 6), (5369238928, 713782, 6), (5369238928, 726972, 6), (5369238928, 727064, 6), (5369238928, 727914, 6), (5369238928, 741554, 6), (5369238928, 754946, 6), (5369238928, 768573, 6), (5369238928, 769652, 6), (5369238928, 783246, 6), (5369238928, 796699, 6), (5369238928, 810169, 6), (5369238928, 823140, 6), (5369238928, 835938, 6), (5369238928, 849252, 6), (5369238928, 862140, 6), (5369577056, 877106, 6), (5369577056, 890696, 6), (5369577056, 903590, 6), (5369577056, 916469, 6), (5369577056, 917479, 6), (5369577056, 930667, 6), (5369577056, 943743, 6), (5369577056, 956461, 6), (5369577056, 969851, 6), (5369577056, 982781, 6), (5369577056, 995605, 6), (5369577056, 1008940, 6), (5369577056, 1009204, 6), (5369577056, 1009530, 6), (5369577056, 1009864, 6), (5369577056, 1009952, 6), (5369577056, 1010054, 6), (5369577056, 1023684, 6), (5369577056, 1036733, 6), (5369577056, 1050079, 6), (5369577056, 1064243, 6), (5369577056, 1078294, 6), (5369577056, 1091911, 6), (5369577056, 1105428, 6), (5369577056, 1118562, 6), (5369577056, 1131479, 6), (5369577056, 1144343, 6), (5369577056, 1144726, 6), (5369577056, 1145169, 6), (5369577056, 1158316, 6), (5369577056, 1172069, 6), (5369577056, 1185073, 6), (5369577056, 1198043, 6), (5369577056, 1211333, 6), (5369577056, 1224594, 6), (5369939616, 1236995, 6), (5369939616, 1237110, 6), (5369939616, 1237260, 6), (5369939616, 1237498, 6), (5369939616, 1237648, 6), (5369939616, 1237822, 6), (5369939616, 1248717, 6), (5369939616, 1259805, 6), (5369939616, 1260316, 6), (5369939616, 1260513, 6), (5369939616, 1260590, 6), (5369939616, 1271777, 6), (5369985376, 1284652, 6), (5369985376, 1286016, 6), (5369985376, 1299363, 6), (5369985376, 1312669, 6), (5369985376, 1325471, 6), (5369985376, 1325795, 6), (5369985376, 1326226, 6), (5369985376, 1326620, 6), (5369985376, 1326726, 6), (5369985376, 1326846, 6), (5369985376, 1340458, 6), (5369985376, 1340936, 6), (5369985376, 1341177, 6), (5369985376, 1341801, 6), (5369985376, 1354805, 6), (5369985376, 1367875, 6), (5369985376, 1380593, 6), (5369985376, 1393771, 6), (5369985376, 1406567, 6), (5369985376, 1407085, 6), (5369985376, 1407723, 6), (5369985376, 1421014, 6), (5369985376, 1434063, 6), (5369985376, 1447409, 6), (5369985376, 1460350, 6), (5369985376, 1473068, 6), (5369985376, 1473556, 6), (5369985376, 1474141, 6), (5369985376, 1474255, 6), (5369985376, 1474278, 6), (5369985376, 1487712, 6), (5369985376, 1489087, 6), (5369985376, 1502846, 6), (5369985376, 1503278, 6), (5369985376, 1503395, 6), (5369985376, 1503671, 6), (5369985376, 1503858, 6), (5369985376, 1504096, 6), (5369985376, 1504119, 6), (5369985376, 1517089, 6), (5369985376, 1518453, 6), (5369985376, 1532530, 6), (5369985376, 1545647, 6), (5369985376, 1558696, 6), (5369985376, 1571672, 6), (5369985376, 1585351, 6), (5369985376, 1585783, 6), (5369985376, 1585900, 6), (5369985376, 1586176, 6), (5369985376, 1586363, 6), (5369985376, 1586601, 6), (5369985376, 1586624, 6), (5369985376, 1599959, 6), (5369985376, 1600150, 6), (5369985376, 1600387, 6), (5369985376, 1600732, 6), (5369985376, 1600971, 6), (5369985376, 1601222, 6), (5369985376, 1614428, 6), (5369985376, 1627562, 6), (5369985376, 1640358, 6), (5369985376, 1653092, 6), (5369985376, 1666748, 6), (5369985376, 1680033, 6), (5369985376, 1693476, 6), (5369985376, 1706391, 6), (5369985376, 1707755, 6), (5369985376, 1720551, 6), (5369985376, 1721029, 6), (5369985376, 1721270, 6), (5369985376, 1721894, 6), (5369985376, 1735003, 6), (5369985376, 1748308, 6), (5369985376, 1749683, 6), (5369985376, 1763336, 6), (5369985376, 1776230, 6), (5369985376, 1789851, 6), (5369985376, 1802711, 6), (5369985376, 1802902, 6), (5369985376, 1803139, 6), (5369985376, 1803484, 6), (5369985376, 1803723, 6), (5369985376, 1803974, 6), (5369985376, 1817378, 6), (5369985376, 1830329, 6), (5369985376, 1843803, 6), (5369985376, 1844281, 6), (5369985376, 1844522, 6), (5369985376, 1845146, 6), (5369985376, 1857986, 6), (5369985376, 1870828, 6), (5369985376, 1883630, 6), (5369985376, 1897048, 6), (5369985376, 1898423, 6), (5369985376, 1911769, 6), (5369985376, 1925170, 6), (5369985376, 1925658, 6), (5369985376, 1926243, 6), (5369985376, 1926357, 6), (5369985376, 1926380, 6), (5369985376, 1939679, 6), (5369985376, 1952380, 6), (5369985376, 1965182, 6), (5369985376, 1978070, 6), (5369985376, 1979434, 6), (5369985376, 1992833, 6), (5369985376, 2006121, 6), (5369985376, 2018943, 6), (5369985376, 2032364, 6), (5369985376, 2045674, 6), (5369985376, 2058723, 6), (5369985376, 2059241, 6), (5369985376, 2059879, 6), (5369985376, 2073046, 6), (5369985376, 2085897, 6), (5370802096, 2097014, 6), (5370802096, 2104997, 6), (5370802096, 2105825, 6), (5370802096, 2113795, 6), (5370802096, 2121699, 6), (5370802096, 2121814, 6), (5370802096, 2121964, 6), (5370802096, 2122202, 6), (5370802096, 2122352, 6), (5370802096, 2122526, 6), (5370802096, 2130592, 6), (5370802096, 2130873, 6), (5370802096, 2130941, 6), (5370802096, 2131124, 6), (5370802096, 2131256, 6), (5370802096, 2131412, 6), (5370802096, 2131430, 6), (5370802096, 2139472, 6), (5370802096, 2139801, 6), (5370802096, 2139923, 6), (5370802096, 2140351, 6), (5370853888, 2151056, 6), (5370853888, 2151359, 6), (5370853888, 2151757, 6), (5370853888, 2162352, 6), (5370853888, 2172876, 6), (5370853888, 2173174, 6), (5370853888, 2173575, 6), (5370853888, 2173654, 6), (5370853888, 2173672, 6), (5370853888, 2184538, 6), (5370853888, 2195137, 6), (5370853888, 2195418, 6), (5370853888, 2195486, 6), (5370853888, 2195669, 6), (5370853888, 2195801, 6), (5370853888, 2195957, 6), (5370853888, 2195975, 6), (5370853888, 2206512, 6), (5370853888, 2206793, 6), (5370853888, 2206861, 6), (5370853888, 2207044, 6), (5370853888, 2207176, 6), (5370853888, 2207332, 6), (5370853888, 2207350, 6), (5370853888, 2217853, 6), (5370853888, 2228562, 6), (5370853888, 2239289, 6), (5370853888, 2249840, 6), (5370964176, 2258795, 6), (5370972048, 2266667, 6), (5370979920, 2274539, 6), (5370987792, 2282411, 6), (5370995664, 2290283, 6), (5371003536, 2298155, 6), (5371011408, 2306027, 6), (5371019280, 2313899, 6), (5371027184, 2321803, 6), (5371035056, 2329675, 6), (5371042928, 2337547, 6), (5371050800, 2345419, 6), (5371058672, 2353291, 6), (5371066544, 2361163, 6), (5371074416, 2369035, 6), (5371082288, 2376907, 6), (5371090160, 2384779, 6), (5371098032, 2392651, 6), (5371105904, 2400523, 6), (5371113776, 2408395, 6), (5371121648, 2416267, 6), (5371129520, 2424139, 6), (5371137392, 2432011, 6), (5371145264, 2439883, 6), (5371153136, 2447755, 6), (5371161008, 2455627, 6), (5371168880, 2463499, 6), (5371176752, 2471371, 6), (5371184624, 2479243, 6), (5371192496, 2487115, 6), (5371200368, 2494987, 6), (5371208240, 2502859, 6), (5371216112, 2510731, 6), (5371223984, 2518603, 6), (5371231856, 2526475, 6), (5371239728, 2534347, 6), (5371247600, 2542219, 6), (5371255472, 2550091, 6), (5371263344, 2557963, 6), (5371271216, 2565835, 6), (5371279088, 2573707, 6), (5371286960, 2581579, 6), (5371294832, 2589451, 6), (5371302768, 2597387, 6), (5371310640, 2605259, 6), (5371318512, 2613131, 6), (5371326384, 2621003, 6), (5371334256, 2628875, 6), (5371342128, 2636747, 6), (5371350000, 2644619, 6), (5371357872, 2652491, 6), (5371365744, 2660363, 6), (5371373616, 2668235, 6), (5371381488, 2676107, 6), (5371389360, 2683979, 6), (5371397232, 2691851, 6), (5371405104, 2699723, 6), (5371412976, 2707595, 6), (5371420848, 2715467, 6), (5371428720, 2723339, 6), (5371436592, 2731211, 6), (5371444752, 2739371, 6), (5371452624, 2747243, 6), (5371460496, 2755115, 6), (5371468368, 2762987, 6), (5371476240, 2770859, 6), (5371484112, 2778731, 6), (5371491984, 2786603, 6), (5371499856, 2794475, 6), (5371507744, 2802363, 6), (5371515616, 2810235, 6), (5371523488, 2818107, 6), (5371531360, 2825979, 6), (5371546368, 2840987, 6), (5371554240, 2848859, 6), (5371562112, 2856731, 6), (5371569984, 2864603, 6), (5371577856, 2872475, 6), (5371585728, 2880347, 6), (5371593600, 2888219, 6), (5371601472, 2896091, 6), (5371609344, 2903963, 6), (5371617216, 2911835, 6), (5371625088, 2919707, 6), (5371632960, 2927579, 6), (5371640832, 2935451, 6), (5371658816, 2946006, 6), (5371658816, 2946492, 6), (5371658816, 2946587, 6), (5371658816, 2946607, 6), (5371658816, 2954277, 6), (5371658816, 2962055, 6), (5371675296, 2962486, 6), (5371675296, 2962972, 6), (5371675296, 2963067, 6), (5371675296, 2963087, 6), (5371675296, 2970763, 6), (5371675296, 2978859, 6), (5371692096, 2979286, 6), (5371692096, 2979772, 6), (5371692096, 2979867, 6), (5371692096, 2979887, 6), (5371692096, 2987557, 6), (5371692096, 2995335, 6), (5371708576, 2995766, 6), (5371708576, 2996252, 6), (5371708576, 2996347, 6), (5371708576, 2996367, 6), (5371708576, 3004043, 6), (5371708576, 3011947, 6), (5371725184, 3012374, 6), (5371725184, 3012860, 6), (5371725184, 3012955, 6), (5371725184, 3012975, 6), (5371725184, 3020651, 6), (5371725184, 3028747, 6), (5371741984, 3029174, 6), (5371741984, 3029660, 6), (5371741984, 3029755, 6), (5371741984, 3029775, 6), (5371741984, 3037451, 6), (5371741984, 3045547, 6), (5371758784, 3045974, 6), (5371758784, 3046460, 6), (5371758784, 3046555, 6), (5371758784, 3046575, 6), (5371758784, 3054251, 6), (5371758784, 3062251, 6), (5371775488, 3062678, 6), (5371775488, 3063164, 6), (5371775488, 3063259, 6), (5371775488, 3063279, 6), (5371775488, 3070955, 6), (5371775488, 3078811, 6), (5371792048, 3079238, 6), (5371792048, 3079724, 6), (5371792048, 3079819, 6), (5371792048, 3079839, 6), (5371792048, 3087509, 6), (5371792048, 3095267, 6), (5371808512, 3095702, 6), (5371808512, 3096188, 6), (5371808512, 3096283, 6), (5371808512, 3096303, 6), (5371808512, 3103973, 6), (5371808512, 3111731, 6), (5371824976, 3112166, 6), (5371824976, 3112652, 6), (5371824976, 3112747, 6), (5371824976, 3112767, 6), (5371824976, 3120443, 6), (5371824976, 3128539, 6), (5371841776, 3128966, 6), (5371841776, 3129452, 6), (5371841776, 3129547, 6), (5371841776, 3129567, 6), (5371841776, 3137243, 6), (5371841776, 3145147, 6), (5371858384, 3145574, 6), (5371858384, 3146060, 6), (5371858384, 3146155, 6), (5371858384, 3146175, 6), (5371858384, 3153851, 6), (5371858384, 3161707, 6), (5371874944, 3162134, 6), (5371874944, 3162620, 6), (5371874944, 3162715, 6), (5371874944, 3162735, 6), (5371874944, 3170405, 6), (5371874944, 3178163, 6), (5371891408, 3178598, 6), (5371891408, 3179084, 6), (5371891408, 3179179, 6), (5371891408, 3179199, 6), (5371891408, 3186875, 6), (5371891408, 3194779, 6), (5371908016, 3195206, 6), (5371908016, 3195692, 6), (5371908016, 3195787, 6), (5371908016, 3195807, 6), (5371908016, 3203477, 6), (5371908016, 3211275, 6), (5371924512, 3211702, 6), (5371924512, 3212188, 6), (5371924512, 3212283, 6), (5371924512, 3212303, 6), (5371924512, 3219979, 6), (5371924512, 3227979, 6), (5371941216, 3228406, 6), (5371941216, 3228892, 6), (5371941216, 3228987, 6), (5371941216, 3229007, 6), (5371941216, 3236677, 6), (5371941216, 3244435, 6), (5371957680, 3244870, 6), (5371957680, 3245356, 6), (5371957680, 3245451, 6), (5371957680, 3245471, 6), (5371957680, 3253141, 6), (5371957680, 3260899, 6), (5371974144, 3261334, 6), (5371974144, 3261820, 6), (5371974144, 3261915, 6), (5371974144, 3261935, 6), (5371974144, 3269611, 6), (5371974144, 3277707, 6), (5371990944, 3278134, 6), (5371990944, 3278620, 6), (5371990944, 3278715, 6), (5371990944, 3278735, 6), (5371990944, 3286411, 6), (5371990944, 3294315, 6), (5372007552, 3294742, 6), (5372007552, 3295228, 6), (5372007552, 3295323, 6), (5372007552, 3295343, 6), (5372007552, 3303019, 6), (5372007552, 3310875, 6), (5372024112, 3311302, 6), (5372024112, 3311788, 6), (5372024112, 3311883, 6), (5372024112, 3311903, 6), (5372024112, 3319573, 6), (5372024112, 3327331, 6), (5372040576, 3327766, 6), (5372040576, 3328252, 6), (5372040576, 3328347, 6), (5372040576, 3328367, 6), (5372040576, 3336043, 6), (5372040576, 3344123, 6), (5372057360, 3344550, 6), (5372057360, 3345036, 6), (5372057360, 3345131, 6), (5372057360, 3345151, 6), (5372057360, 3352821, 6), (5372057360, 3360589, 6), (5372073824, 3361014, 6), (5372073824, 3361500, 6), (5372073824, 3361595, 6), (5372073824, 3361615, 6), (5372073824, 3369285, 6), (5372073824, 3377053, 6), (5372090288, 3377478, 6), (5372090288, 3377964, 6), (5372090288, 3378059, 6), (5372090288, 3378079, 6), (5372090288, 3385755, 6), (5372090288, 3393659, 6), (5372106896, 3394086, 6), (5372106896, 3394572, 6), (5372106896, 3394667, 6), (5372106896, 3394687, 6), (5372106896, 3402363, 6), (5372106896, 3410219, 6), (5372123456, 3410646, 6), (5372123456, 3411132, 6), (5372123456, 3411227, 6), (5372123456, 3411247, 6), (5372123456, 3418923, 6), (5372123456, 3426827, 6), (5372140064, 3427254, 6), (5372140064, 3427740, 6), (5372140064, 3427835, 6), (5372140064, 3427855, 6), (5372140064, 3435525, 6), (5372140064, 3443283, 6), (5372156528, 3443718, 6), (5372156528, 3444204, 6), (5372156528, 3444299, 6), (5372156528, 3444319, 6), (5372156528, 3451995, 6), (5372156528, 3459851, 6), (5372173088, 3460278, 6), (5372173088, 3460764, 6), (5372173088, 3460859, 6), (5372173088, 3460879, 6), (5372173088, 3468555, 6), (5372173088, 3476411, 6), (5372189648, 3476838, 6), (5372189648, 3477324, 6), (5372189648, 3477419, 6), (5372189648, 3477439, 6), (5372189648, 3485109, 6), (5372189648, 3492877, 6), (5372206112, 3493302, 6), (5372206112, 3493788, 6), (5372206112, 3493883, 6), (5372206112, 3493903, 6), (5372206112, 3501579, 6), (5372206112, 3509675, 6), (5372222912, 3510102, 6), (5372222912, 3510588, 6), (5372222912, 3510683, 6), (5372222912, 3510703, 6), (5372222912, 3518379, 6), (5372222912, 3526283, 6), (5372239520, 3526710, 6), (5372239520, 3527196, 6), (5372239520, 3527291, 6), (5372239520, 3527311, 6), (5372239520, 3534981, 6), (5372239520, 3542759, 6), (5372256000, 3543190, 6), (5372256000, 3543676, 6), (5372256000, 3543771, 6), (5372256000, 3543791, 6), (5372256000, 3551461, 6), (5372256000, 3559229, 6), (5372272464, 3559654, 6), (5372272464, 3560140, 6), (5372272464, 3560235, 6), (5372272464, 3560255, 6), (5372272464, 3567925, 6), (5372272464, 3575683, 6), (5372288928, 3576118, 6), (5372288928, 3576604, 6), (5372288928, 3576699, 6), (5372288928, 3576719, 6), (5372288928, 3584395, 6), (5372288928, 3592299, 6), (5372305536, 3592726, 6), (5372305536, 3593212, 6), (5372305536, 3593307, 6), (5372305536, 3593327, 6), (5372305536, 3601003, 6), (5372305536, 3608859, 6), (5372322096, 3609286, 6), (5372322096, 3609772, 6), (5372322096, 3609867, 6), (5372322096, 3609887, 6), (5372322096, 3617563, 6), (5372322096, 3625419, 6), (5372338656, 3625846, 6), (5372338656, 3626332, 6), (5372338656, 3626427, 6), (5372338656, 3626447, 6), (5372338656, 3634123, 6), (5372338656, 3642219, 6), (5372355456, 3642646, 6), (5372355456, 3643132, 6), (5372355456, 3643227, 6), (5372355456, 3643247, 6), (5372355456, 3650923, 6), (5372355456, 3658779, 6), (5372372016, 3659206, 6), (5372372016, 3659692, 6), (5372372016, 3659787, 6), (5372372016, 3659807, 6), (5372372016, 3667483, 6), (5372372016, 3675339, 6), (5372388576, 3675766, 6), (5372388576, 3676252, 6), (5372388576, 3676347, 6), (5372388576, 3676367, 6), (5372388576, 3684037, 6), (5372388576, 3691805, 6), (5372405040, 3692230, 6), (5372405040, 3692716, 6), (5372405040, 3692811, 6), (5372405040, 3692831, 6), (5372405040, 3700507, 6), (5372405040, 3708411, 6), (5372421648, 3708838, 6), (5372421648, 3709324, 6), (5372421648, 3709419, 6), (5372421648, 3709439, 6), (5372421648, 3717109, 6), (5372421648, 3724867, 6), (5372438112, 3725302, 6), (5372438112, 3725788, 6), (5372438112, 3725883, 6), (5372438112, 3725903, 6), (5372438112, 3733573, 6), (5372438112, 3741351, 6), (5372454592, 3741782, 6), (5372454592, 3742268, 6), (5372454592, 3742363, 6), (5372454592, 3742383, 6), (5372454592, 3750053, 6), (5372454592, 3757821, 6), (5372471056, 3758246, 6), (5372471056, 3758732, 6), (5372471056, 3758827, 6), (5372471056, 3758847, 6), (5372471056, 3766523, 6), (5372471056, 3774475, 6), (5372487712, 3774902, 6), (5372487712, 3775388, 6), (5372487712, 3775483, 6), (5372487712, 3775503, 6), (5372487712, 3783179, 6), (5372487712, 3791035, 6), (5372504272, 3791462, 6), (5372504272, 3791948, 6), (5372504272, 3792043, 6), (5372504272, 3792063, 6), (5372504272, 3799739, 6), (5372504272, 3807643, 6), (5372520880, 3808070, 6), (5372520880, 3808556, 6), (5372520880, 3808651, 6), (5372520880, 3808671, 6), (5372520880, 3816347, 6), (5372520880, 3824251, 6), (5372537488, 3824678, 6), (5372537488, 3825164, 6), (5372537488, 3825259, 6), (5372537488, 3825279, 6), (5372537488, 3832955, 6), (5372537488, 3840811, 6), (5372554048, 3841238, 6), (5372554048, 3841724, 6), (5372554048, 3841819, 6), (5372554048, 3841839, 6), (5372554048, 3849515, 6), (5372554048, 3857371, 6), (5372570608, 3857798, 6), (5372570608, 3858284, 6), (5372570608, 3858379, 6), (5372570608, 3858399, 6), (5372570608, 3866075, 6), (5372570608, 3874027, 6), (5372587264, 3874454, 6), (5372587264, 3874940, 6), (5372587264, 3875035, 6), (5372587264, 3875055, 6), (5372587264, 3882731, 6), (5372587264, 3890731, 6), (5372603968, 3891158, 6), (5372603968, 3891644, 6), (5372603968, 3891739, 6), (5372603968, 3891759, 6), (5372603968, 3899435, 6), (5372603968, 3907435, 6), (5372620672, 3907862, 6), (5372620672, 3908348, 6), (5372620672, 3908443, 6), (5372620672, 3908463, 6), (5372620672, 3916139, 6), (5372620672, 3924251, 6), (5372637488, 3924678, 6), (5372637488, 3925164, 6), (5372637488, 3925259, 6), (5372637488, 3925279, 6), (5372637488, 3932949, 6), (5372637488, 3940747, 6), (5372653984, 3941174, 6), (5372653984, 3941660, 6), (5372653984, 3941755, 6), (5372653984, 3941775, 6), (5372653984, 3949445, 6), (5372653984, 3957233, 6), (5372670464, 3957654, 6), (5372670464, 3958140, 6), (5372670464, 3958235, 6), (5372670464, 3958255, 6), (5372670464, 3965931, 6), (5372670464, 3973787, 6), (5372687024, 3974214, 6), (5372687024, 3974700, 6), (5372687024, 3974795, 6), (5372687024, 3974815, 6), (5372687024, 3982491, 6), (5372687024, 3990587, 6), (5372703824, 3991014, 6), (5372703824, 3991500, 6), (5372703824, 3991595, 6), (5372703824, 3991615, 6), (5372703824, 3999291, 6), (5372703824, 4007387, 6), (5372720624, 4007814, 6), (5372720624, 4008300, 6), (5372720624, 4008395, 6), (5372720624, 4008415, 6), (5372720624, 4016085, 6), (5372720624, 4023843, 6), (5372737088, 4024278, 6), (5372737088, 4024764, 6), (5372737088, 4024859, 6), (5372737088, 4024879, 6), (5372737088, 4032549, 6), (5372737088, 4040307, 6), (5372753552, 4040742, 6), (5372753552, 4041228, 6), (5372753552, 4041323, 6), (5372753552, 4041343, 6), (5372753552, 4049013, 6), (5372753552, 4056771, 6), (5372770016, 4057206, 6), (5372770016, 4057692, 6), (5372770016, 4057787, 6), (5372770016, 4057807, 6), (5372770016, 4065477, 6), (5372770016, 4073235, 6), (5372786480, 4073670, 6), (5372786480, 4074156, 6), (5372786480, 4074251, 6), (5372786480, 4074271, 6), (5372786480, 4081941, 6), (5372786480, 4089699, 6), (5372802944, 4090134, 6), (5372802944, 4090620, 6), (5372802944, 4090715, 6), (5372802944, 4090735, 6), (5372802944, 4098405, 6), (5372802944, 4106163, 6), (5372819408, 4106598, 6), (5372819408, 4107084, 6), (5372819408, 4107179, 6), (5372819408, 4107199, 6), (5372819408, 4114875, 6), (5372819408, 4122779, 6), (5372836016, 4123206, 6), (5372836016, 4123692, 6), (5372836016, 4123787, 6), (5372836016, 4123807, 6), (5372836016, 4131483, 6), (5372836016, 4139387, 6), (5372852624, 4139814, 6), (5372852624, 4140300, 6), (5372852624, 4140395, 6), (5372852624, 4140415, 6), (5372852624, 4148091, 6), (5372852624, 4156187, 6), (5372871056, 4158246, 6), (5372871056, 4158732, 6), (5372871056, 4158827, 6), (5372871056, 4158847, 6), (5372871056, 4166523, 6), (5372871056, 4174379, 6), (5372887616, 4174806, 6), (5372887616, 4175292, 6), (5372887616, 4175387, 6), (5372887616, 4175407, 6), (5372887616, 4183083, 6), (5372887616, 4190987, 6), (5372904224, 4191414, 6), (5372904224, 4191900, 6), (5372904224, 4191995, 6), (5372904224, 4192015, 6), (5372904224, 4199691, 6), (5372904224, 4207595, 6), (5372920832, 4208022, 6), (5372920832, 4208508, 6), (5372920832, 4208603, 6), (5372920832, 4208623, 6), (5372920832, 4216299, 6), (5372920832, 4224331, 6), (5372937568, 4224758, 6), (5372937568, 4225244, 6), (5372937568, 4225339, 6), (5372937568, 4225359, 6), (5372937568, 4233035, 6), (5372937568, 4241035, 6), (5372954272, 4241462, 6), (5372954272, 4241948, 6), (5372954272, 4242043, 6), (5372954272, 4242063, 6), (5372954272, 4249739, 6), (5372954272, 4257739, 6), (5372970976, 4258166, 6), (5372970976, 4258652, 6), (5372970976, 4258747, 6), (5372970976, 4258767, 6), (5372970976, 4266443, 6), (5372970976, 4274347, 6), (5372987584, 4274774, 6), (5372987584, 4275260, 6), (5372987584, 4275355, 6), (5372987584, 4275375, 6), (5372987584, 4283051, 6), (5372987584, 4290955, 6), (5373004192, 4291382, 6), (5373004192, 4291868, 6), (5373004192, 4291963, 6), (5373004192, 4291983, 6), (5373004192, 4299659, 6), (5373004192, 4307515, 6), (5373020752, 4307942, 6), (5373020752, 4308428, 6), (5373020752, 4308523, 6), (5373020752, 4308543, 6), (5373020752, 4316213, 6), (5373020752, 4324001, 6), (5373037232, 4324422, 6), (5373037232, 4324908, 6), (5373037232, 4325003, 6), (5373037232, 4325023, 6), (5373037232, 4332699, 6), (5373037232, 4340555, 6), (5373053792, 4340982, 6), (5373053792, 4341468, 6), (5373053792, 4341563, 6), (5373053792, 4341583, 6), (5373053792, 4349253, 6), (5373053792, 4357041, 6), (5373070272, 4357462, 6), (5373070272, 4357948, 6), (5373070272, 4358043, 6), (5373070272, 4358063, 6), (5373070272, 4365739, 6), (5373070272, 4373643, 6), (5373227889, 4526726, 6), (5373240252, 4539058, 6), (5373254445, 4552703, 6), (5373254445, 4553560, 6), (5373268187, 4564408, 6), (5373268187, 4565056, 6), (5373278739, 4577159, 6), (5373278739, 4589173, 6), (5373278739, 4589610, 6), (5373278739, 4590133, 6), (5373278739, 4590236, 6), (5373278739, 4590258, 6), (5373307300, 4603582, 6)]
    if len(sys.argv) != 3:
        print("Usage: pe_nop_patch.py <input.exe> <output.exe>")
        sys.exit(1)
    main(sys.argv[1], sys.argv[2])



