/* This file was generated by the Hex-Rays decompiler version 7.7.0.220118.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

__int64 (**init_proc())(void);
int __cdecl main(int argc, const char **argv, const char **envp);
int GLOBAL__sub_I_man();
void __fastcall __noreturn start(__int64, __int64, void (*)(void));
void *deregister_tm_clones();
__int64 register_tm_clones(void); // weak
void *_do_global_dtors_aux();
__int64 __fastcall frame_dummy(); // weak
__int64 getu32(void); // idb
__int64 setnote(void); // idb
__int64 shownote(void); // idb
__int64 upgradenote(void); // idb
__int64 __fastcall std::ctype<char>::do_widen(__int64 a1, unsigned int a2);
void __fastcall NoteManager::~NoteManager(NoteManager *this);
void term_proc();
// int __fastcall _cxa_finalize(void *);
// int __fastcall _libc_start_main(int (__fastcall *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end);
// int __fastcall _cxa_atexit(void (__fastcall *lpfunc)(void *), void *obj, void *lpdso_handle);
// _QWORD std::ios_base::Init::Init(std::ios_base::Init *__hidden this); idb
// void __fastcall std::ios_base::Init::~Init(std::ios_base::Init *__hidden this); idb
// __int64 _gmon_start__(void); weak

//-------------------------------------------------------------------------
// Data declarations

void *_dso_handle = &_dso_handle; // idb
_UNKNOWN _bss_start; // weak
char completed_0; // weak
NoteManager notemanager; // weak
_UNKNOWN std::__ioinit; // weak


//----- (0000564B64492000) ----------------------------------------------------
__int64 (**init_proc())(void)
{
  __int64 (**result)(void); // rax

  result = &_gmon_start__;
  if ( &_gmon_start__ )
    return (__int64 (**)(void))_gmon_start__();
  return result;
}
// 564B644959C8: using guessed type __int64 _gmon_start__(void);

//----- (0000564B64492020) ----------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  unsigned int choice; // eax
  bool v4; // cf
  bool v5; // zf

  do
  {
LABEL_1:
    while ( 1 )
    {
      choice = getu32();
      v4 = choice < 3;
      v5 = choice == 3;
      if ( choice != 3 )
        break;
LABEL_6:
      upgradenote();
    }
    while ( v4 || v5 )
    {
      if ( choice == 1 )
      {
        setnote();
        goto LABEL_1;
      }
      if ( choice != 2 )
        goto LABEL_1;
      shownote();
      choice = getu32();
      v4 = choice < 3;
      v5 = choice == 3;
      if ( choice == 3 )
        goto LABEL_6;
    }
  }
  while ( choice != 4 );
  return 0;
}

//----- (0000564B64492070) ----------------------------------------------------
int GLOBAL__sub_I_man()
{
  std::ios_base::Init::Init((std::ios_base::Init *)&std::__ioinit);
  _cxa_atexit((void (__fastcall *)(void *))&std::ios_base::Init::~Init, &std::__ioinit, &_dso_handle);
  notemanager.strings[0].len = 0LL;
  notemanager.strings[0].field_0 = (__int64)&notemanager.strings[0].field_10;
  notemanager.strings[1].field_0 = (__int64)&notemanager.strings[1].field_10;
  notemanager.strings[2].field_0 = (__int64)&notemanager.strings[2].field_10;
  LOBYTE(notemanager.strings[0].field_10) = 0;
  notemanager.strings[1].len = 0LL;
  LOBYTE(notemanager.strings[1].field_10) = 0;
  notemanager.strings[2].len = 0LL;
  LOBYTE(notemanager.strings[2].field_10) = 0;
  notemanager.strings[3].field_0 = (__int64)&notemanager.strings[3].field_10;
  notemanager.strings[3].len = 0LL;
  LOBYTE(notemanager.strings[3].field_10) = 0;
  return _cxa_atexit((void (__fastcall *)(void *))NoteManager::~NoteManager, &notemanager, &_dso_handle);
}
// 564B644953A0: using guessed type NoteManager notemanager;

//----- (0000564B64492140) ----------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)(void))
{
  __int64 v3; // rax
  int v4; // esi
  __int64 v5; // [rsp-8h] [rbp-8h] BYREF
  char *retaddr; // [rsp+0h] [rbp+0h] BYREF

  v4 = v5;
  v5 = v3;
  _libc_start_main((int (__fastcall *)(int, char **, char **))main, v4, &retaddr, 0LL, 0LL, a3, &v5);
  __halt();
}
// 564B6449214A: positive sp value 8 has been found
// 564B64492151: variable 'v3' is possibly undefined

//----- (0000564B64492170) ----------------------------------------------------
void *deregister_tm_clones()
{
  return &_bss_start;
}

//----- (0000564B644921A0) ----------------------------------------------------
__int64 register_tm_clones()
{
  return 0LL;
}
// 564B644921A0: using guessed type __int64 __fastcall register_tm_clones();

//----- (0000564B644921E0) ----------------------------------------------------
void *_do_global_dtors_aux()
{
  void *result; // rax

  if ( completed_0 )
    return result;
  if ( &_cxa_finalize )
    _cxa_finalize(_dso_handle);
  result = deregister_tm_clones();
  completed_0 = 1;
  return result;
}
// 564B64495390: using guessed type char completed_0;

//----- (0000564B64492230) ----------------------------------------------------
__int64 frame_dummy()
{
  return register_tm_clones();
}
// 564B644921A0: using guessed type __int64 register_tm_clones(void);
// 564B64492230: using guessed type __int64 __fastcall frame_dummy();

//----- (0000564B64492240) ----------------------------------------------------
void __noreturn error(void)
{
  __int64 v0; // rax
  _BYTE *v1; // rbx
  char v2; // si
  std::ostream *v3; // rax
  __int64 (__fastcall *v4)(); // rax

  std::__ostream_insert<char,std::char_traits<char>>(std::cerr, "error!!!", 8LL);
  v0 = *(_QWORD *)(std::cerr[0] - 24LL);
  v1 = *(_BYTE **)((char *)&std::cerr[30] + v0);
  if ( v1 )
  {
    if ( v1[56] )
    {
      v2 = v1[67];
    }
    else
    {
      std::ctype<char>::_M_widen_init(*(_QWORD *)((char *)&std::cerr[30] + v0));
      v2 = 10;
      v4 = *(__int64 (__fastcall **)())(*(_QWORD *)v1 + 48LL);
      if ( v4 != std::ctype<char>::do_widen )
        v2 = ((__int64 (__fastcall *)(_BYTE *, __int64))v4)(v1, 10LL);
    }
    v3 = (std::ostream *)std::ostream::put((std::ostream *)std::cerr, v2);
    std::ostream::flush(v3);
    exit(1);
  }
  std::__throw_bad_cast();
}
// 564B64492730: using guessed type __int64 __fastcall std::ctype<char>::do_widen();
// 564B64495280: using guessed type _QWORD std::cerr[34];
// 564B64495970: using guessed type __int64 __fastcall std::__ostream_insert<char,std::char_traits<char>>(_QWORD, _QWORD, _QWORD);
// 564B64495978: using guessed type __int64 __fastcall std::ctype<char>::_M_widen_init(_QWORD);

//----- (0000564B644922E0) ----------------------------------------------------
__int64 getu32(void)
{
  __int64 v0; // rax
  _BYTE *v1; // rbx
  char v2; // si
  std::ostream *v3; // rax
  _QWORD *v4; // rax
  __int64 result; // rax
  __int64 (__fastcall *v6)(); // rax
  unsigned int v7; // [rsp+4h] [rbp-24h] BYREF
  unsigned __int64 v8; // [rsp+8h] [rbp-20h]

  v8 = __readfsqword(0x28u);
  std::__ostream_insert<char,std::char_traits<char>>(std::cout, "?", 1LL);
  v0 = *(_QWORD *)(std::cout[0] - 24);
  v1 = *(_BYTE **)((char *)&std::cout[30] + v0);
  if ( !v1 )
    std::__throw_bad_cast();
  if ( v1[56] )
  {
    v2 = v1[67];
  }
  else
  {
    std::ctype<char>::_M_widen_init(*(__int64 *)((char *)&std::cout[30] + v0));
    v2 = 10;
    v6 = *(__int64 (__fastcall **)())(*(_QWORD *)v1 + 48LL);
    if ( v6 != std::ctype<char>::do_widen )
      v2 = ((__int64 (__fastcall *)(_BYTE *, __int64))v6)(v1, 10LL);
  }
  v3 = (std::ostream *)std::ostream::put((std::ostream *)std::cout, v2);
  std::ostream::flush(v3);
  v4 = (_QWORD *)std::istream::_M_extract<unsigned int>(&std::cin, &v7);
  if ( (((unsigned __int8)dword_564B64495190 | *((_BYTE *)v4 + *(_QWORD *)(*v4 - 24LL) + 32)) & 5) != 0 )
    error();
  result = v7;
  if ( v8 != __readfsqword(0x28u) )
    _stack_chk_fail();
  return result;
}
// 564B644923C9: control flows out of bounds to 564B644923CF
// 564B64492730: using guessed type __int64 __fastcall std::ctype<char>::do_widen();
// 564B64495040: using guessed type __int64 std::cout[36];
// 564B64495190: using guessed type int dword_564B64495190;
// 564B64495968: using guessed type void __noreturn _stack_chk_fail(void);
// 564B64495970: using guessed type __int64 __fastcall std::__ostream_insert<char,std::char_traits<char>>(_QWORD, _QWORD, _QWORD);
// 564B64495978: using guessed type __int64 __fastcall std::ctype<char>::_M_widen_init(_QWORD);
// 564B644959B0: using guessed type __int64 __fastcall std::istream::_M_extract<unsigned int>(_QWORD, _QWORD);

//----- (0000564B644923D0) ----------------------------------------------------
__int64 setnote(void)
{
  unsigned int v0; // eax
  unsigned int read_str; // ebx
  unsigned int v2; // eax
  __int64 idx; // r12
  __int64 v4; // rax
  _BYTE *v5; // r13
  char v6; // si
  std::ostream *v7; // rax
  __int64 read_chars; // r14
  char *v9; // rbx
  int c; // eax
  __int64 result; // rax
  __int64 (__fastcall *v12)(); // rax

  v0 = getu32();
  if ( v0 > 1 || (read_str = v0, v2 = getu32(), idx = v2, v2 > 4) )
    error();
  while ( (unsigned int)std::istream::get((std::istream *)&std::cin) != 10 && (dword_564B64495190 & 2) == 0 )
    ;
  std::__ostream_insert<char,std::char_traits<char>>(std::cout, "?", 1LL);
  v4 = *(_QWORD *)(std::cout[0] - 24);
  v5 = *(_BYTE **)((char *)&std::cout[30] + v4);
  if ( !v5 )
    std::__throw_bad_cast();
  if ( v5[56] )
  {
    v6 = v5[67];
  }
  else
  {
    std::ctype<char>::_M_widen_init(*(__int64 *)((char *)&std::cout[30] + v4));
    v6 = 10;
    v12 = *(__int64 (__fastcall **)())(*(_QWORD *)v5 + 48LL);
    if ( v12 != std::ctype<char>::do_widen )
      v6 = ((__int64 (__fastcall *)(_BYTE *, __int64))v12)(v5, 10LL);
  }
  v7 = (std::ostream *)std::ostream::put((std::ostream *)std::cout, v6);
  std::ostream::flush(v7);
  if ( !read_str )
    return std::operator>><char>(&std::cin, &notemanager.strings[(unsigned int)idx]);
  if ( (dword_564B64495190 & 2) != 0 )
  {
    read_chars = 0LL;
  }
  else
  {
    read_chars = 0LL;
    v9 = (char *)&notemanager + 160 * idx;
    do
    {
      c = std::istream::get((std::istream *)&std::cin);
      if ( c == 10 )
        break;
      v9[0x80] = c;
      read_chars = (unsigned int)(read_chars + 1);
      if ( (dword_564B64495190 & 2) != 0 )
        break;
      ++v9;
    }
    while ( (_DWORD)read_chars != 0x9F );
  }
  result = 160 * idx;
  notemanager.chars[idx][read_chars] = 0;
  return result;
}
// 564B64492730: using guessed type __int64 __fastcall std::ctype<char>::do_widen();
// 564B64495040: using guessed type __int64 std::cout[36];
// 564B64495190: using guessed type int dword_564B64495190;
// 564B644953A0: using guessed type NoteManager notemanager;
// 564B64495970: using guessed type __int64 __fastcall std::__ostream_insert<char,std::char_traits<char>>(_QWORD, _QWORD, _QWORD);
// 564B64495978: using guessed type __int64 __fastcall std::ctype<char>::_M_widen_init(_QWORD);
// 564B64495998: using guessed type __int64 __fastcall std::operator>><char>(_QWORD, _QWORD);

//----- (0000564B64492570) ----------------------------------------------------
__int64 shownote(void)
{
  unsigned int v0; // eax
  unsigned int as_string; // ebx
  unsigned int idx; // eax
  std::ostream *v3; // rbx
  __int64 v4; // rax
  _BYTE *v5; // rbp
  char v6; // si
  std::ostream *v7; // rdi
  std::ostream *v8; // rax
  const char *v10; // rbx
  size_t v11; // rax
  __int64 v12; // rax
  _BYTE *v13; // rbx
  __int64 (__fastcall *v14)(); // rax
  __int64 (__fastcall *v15)(); // rax

  v0 = getu32();
  if ( v0 > 1 || (as_string = v0, idx = getu32(), idx > 4) )
    error();
  if ( !as_string )
  {
    v3 = (std::ostream *)std::__ostream_insert<char,std::char_traits<char>>(
                           std::cout,
                           notemanager.strings[idx].field_0,
                           notemanager.strings[idx].len);
    v4 = *(_QWORD *)(*(_QWORD *)v3 - 24LL);
    v5 = *(_BYTE **)((char *)v3 + v4 + 240);
    if ( v5 )
    {
      if ( v5[56] )
      {
        v6 = v5[67];
      }
      else
      {
        std::ctype<char>::_M_widen_init(*(_QWORD *)((char *)v3 + v4 + 240));
        v6 = 10;
        v14 = *(__int64 (__fastcall **)())(*(_QWORD *)v5 + 48LL);
        if ( v14 != std::ctype<char>::do_widen )
          v6 = ((__int64 (__fastcall *)(_BYTE *, __int64))v14)(v5, 10LL);
      }
      v7 = v3;
      goto LABEL_8;
    }
LABEL_18:
    std::__throw_bad_cast();
  }
  v10 = notemanager.chars[idx];
  v11 = strlen(v10);
  std::__ostream_insert<char,std::char_traits<char>>(std::cout, v10, v11);
  v12 = *(_QWORD *)(std::cout[0] - 24);
  v13 = *(_BYTE **)((char *)&std::cout[30] + v12);
  if ( !v13 )
    goto LABEL_18;
  if ( v13[56] )
  {
    v6 = v13[67];
  }
  else
  {
    std::ctype<char>::_M_widen_init(*(__int64 *)((char *)&std::cout[30] + v12));
    v6 = 10;
    v15 = *(__int64 (__fastcall **)())(*(_QWORD *)v13 + 48LL);
    if ( v15 != std::ctype<char>::do_widen )
      v6 = ((__int64 (__fastcall *)(_BYTE *, __int64))v15)(v13, 10LL);
  }
  v7 = (std::ostream *)std::cout;
LABEL_8:
  v8 = (std::ostream *)std::ostream::put(v7, v6);
  return std::ostream::flush(v8);
}
// 564B64492730: using guessed type __int64 __fastcall std::ctype<char>::do_widen();
// 564B64495040: using guessed type __int64 std::cout[36];
// 564B644953A0: using guessed type NoteManager notemanager;
// 564B64495970: using guessed type __int64 __fastcall std::__ostream_insert<char,std::char_traits<char>>(_QWORD, _QWORD, _QWORD);
// 564B64495978: using guessed type __int64 __fastcall std::ctype<char>::_M_widen_init(_QWORD);

//----- (0000564B644926D0) ----------------------------------------------------
__int64 upgradenote(void)
{
  unsigned int v0; // eax
  __int64 idx; // rbx
  unsigned int v2; // eax
  const char *v3; // r12
  size_t chars_len; // rax

  v0 = getu32();
  idx = v0;
  if ( v0 > 4 || (v2 = getu32(), v2 > 4) )
    error();
  v3 = notemanager.chars[v2];
  chars_len = strlen(v3);
  return std::string::_M_replace(&notemanager.strings[idx], 0LL, notemanager.strings[idx].len, v3, chars_len);
}
// 564B644953A0: using guessed type NoteManager notemanager;
// 564B644959A8: using guessed type __int64 __fastcall std::string::_M_replace(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000564B64492730) ----------------------------------------------------
__int64 __fastcall std::ctype<char>::do_widen(__int64 a1, unsigned int a2)
{
  return a2;
}

//----- (0000564B64492740) ----------------------------------------------------
void __fastcall NoteManager::~NoteManager(NoteManager *this)
{
  NoteManager *v2; // rbx
  __int64 *v3; // rax
  __int64 *v4; // rdi
  void **v5; // rax

  v2 = (NoteManager *)&this->strings[3];
  v3 = &this->strings[3].field_10;
  v4 = (__int64 *)this->strings[3].field_0;
  if ( v4 == v3 )
    goto LABEL_4;
  while ( 1 )
  {
    operator delete(v4, v2->strings[0].field_10 + 1);
    v5 = (void **)&v2[-1].chars[3][128];
    if ( v2 == this )
      break;
    while ( 1 )
    {
      v2 = (NoteManager *)v5;
      v4 = (__int64 *)*v5;
      if ( *v5 != v5 + 2 )
        break;
LABEL_4:
      v5 = (void **)&v2[-1].chars[3][128];
      if ( v2 == this )
        return;
    }
  }
}

//----- (0000564B64492790) ----------------------------------------------------
void term_proc()
{
  ;
}

// nfuncs=35 queued=16 decompiled=16 lumina nreq=0 worse=0 better=0
// ALL OK, 16 function(s) have been successfully decompiled
