/* This file was generated by the Hex-Rays decompiler version 7.7.0.220118.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>

#include <stdarg.h>

unsigned __int64 final[4] =
{
  10257607335431468783ui64,
  13310764770034890946ui64,
  8148501843903070222ui64,
  6361997708489562924ui64
}; // weak

__int64 qword_14008F9C0[34] =
{
  33537905390868952i64,
  -72683042051368481i64,
  33537913980803544i64,
  33560532352326104i64,
  94860414900696i64,
  33557476483095000i64,
  33561457112472024i64,
  94860414900696i64,
  33534346473593304i64,
  94860414900696i64,
  94860414900696i64,
  33559790128290264i64,
  94860414900696i64,
  94860414900696i64,
  33533524792662488i64,
  33538378911013336i64,
  94860414900696i64,
  94860414900696i64,
  -94860414900697i64,
  33538379447884248i64,
  33538393943398872i64,
  33560122719820248i64,
  33559335935498712i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64,
  94860414900696i64
}; // weak
__int64 qword_14008FAD0 = 0i64; // weak
_QWORD qword_14008FAE0[128] =
{
  2194304i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64,
  0i64
}; // weak
int dword_14008FEE0 = 64; // weak
__int64 qword_14008FEE8 = 0i64; // weak
__int64 qword_14008FEF0 = 0i64; // weak
__int64 qword_14008FEF8 = 2242960i64; // weak
__int64 qword_14008FF00 = 0i64; // weak
int dword_14008FF08 = 0; // weak
int dword_14008FF0C = 0; // weak
_DWORD dword_14008FF10 = 28800; // weak
_DWORD dword_14008FF14 = 1; // weak
_DWORD dword_14008FF18[2] = { -3600, 0 }; // weak
_UNKNOWN unk_14008FF20; // weak
_UNKNOWN unk_14008FF28; // weak
int dword_14008FFEC = 0; // weak
_UNKNOWN unk_14008FFF0; // weak
_UNKNOWN unk_14008FFF8; // weak
_QWORD off_140090000 = 2205184i64; // weak
int dword_140090008 = 0; // weak
char byte_14009000C = '\x01'; // weak
unsigned int dword_140090010 = 0u; // weak
unsigned int dword_140090014 = 0u; // weak
_UNKNOWN unk_140090018; // weak
_UNKNOWN unk_140090020; // weak
_UNKNOWN unk_140090028; // weak
int dword_140090038 = 1; // weak
_UNKNOWN wmctf_file_handle; // weak
void *flag_ptr = &unk_12FBC0; // idb
_UNKNOWN flag_len; // weak
_UNKNOWN welcome_str; // weak
__int64 (__fastcall *NtQueryInformationFile)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD) = &unk_7792BE40; // weak
void *c4 = &unk_21DDC0; // weak
_UNKNOWN unk_140090078; // weak
_UNKNOWN unk_140090080; // weak
int dword_140090088 = 0; // weak

//----- (0000000140006190) ----------------------------------------------------
int printf(const char *const Format, ...)
{
  char *v1; // rax
  va_list va; // [rsp+48h] [rbp+10h] BYREF

  va_start(va, Format);
  v1 = sub_14001B170(1u);
  return sub_140006140((__int64)v1, (__int64)Format, 0i64, (__int64)va);
}

//----- (00000001400061F0) ----------------------------------------------------
__int64 __fastcall sub_1400061F0(__int64 a1, __int64 a2, __int64 a3, __int64 a4)
{
  __int64 *v4; // rax

  v4 = (__int64 *)sub_140006130();
  return sub_14002EF50(*v4, a1, a2, a3, a4);
}

//----- (0000000140006240) ----------------------------------------------------
int scanf(const char *const Format, ...)
{
  char *v1; // rax
  va_list va; // [rsp+48h] [rbp+10h] BYREF

  va_start(va, Format);
  v1 = sub_14001B170(0);
  return sub_1400061F0((__int64)v1, (__int64)Format, 0i64, (__int64)va);
}

//----- (00000001400062A0) ----------------------------------------------------
char __fastcall call_driver(__int64 one, __int64 flag_ptr, __int64 twentyfour)
{
  char IoStatusBlock[24]; // [rsp+38h] [rbp-110h] BYREF
  __int64 FileInformation[28]; // [rsp+50h] [rbp-F8h] BYREF

  memset(FileInformation, 0, sizeof(FileInformation));
  FileInformation[0] = 0x123456111i64;
  FileInformation[1] = one;
  FileInformation[2] = flag_ptr;
  FileInformation[3] = twentyfour;
  memset(IoStatusBlock, 0, 0x10ui64);
  NtQueryInformationFile(wmctf_file_handle, IoStatusBlock, FileInformation, 224i64, 52);
  return 0;
}
// 140090068: using guessed type __int64 (__fastcall *NtQueryInformationFile)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD);
// 1400062A0: using guessed type _QWORD FileInformation[28];

//----- (0000000140006380) ----------------------------------------------------
int create_driver()
{
  _BYTE v1[32]; // [rsp+0h] [rbp-208h] BYREF
  char v2; // [rsp+20h] [rbp-1E8h]
  char *v3; // [rsp+28h] [rbp-1E0h]
  char *v4; // [rsp+30h] [rbp-1D8h]
  CHAR *v5; // [rsp+38h] [rbp-1D0h]
  char *v6; // [rsp+40h] [rbp-1C8h]
  CHAR *v7; // [rsp+48h] [rbp-1C0h]
  char VersionInformation[284]; // [rsp+50h] [rbp-1B8h] BYREF
  char v9[8]; // [rsp+170h] [rbp-98h] BYREF
  CHAR FileName[4]; // [rsp+178h] [rbp-90h] BYREF
  char v11[46]; // [rsp+17Ch] [rbp-8Ch] BYREF
  CHAR v12[56]; // [rsp+1B0h] [rbp-58h] BYREF

  memset(VersionInformation, 0, sizeof(VersionInformation));
  *(_DWORD *)VersionInformation = 284;
  GetVersionExW((LPOSVERSIONINFOW)VersionInformation);
  if ( *(_DWORD *)&VersionInformation[16] == 2
    && *(_DWORD *)&VersionInformation[4] == 6
    && *(_DWORD *)&VersionInformation[8] == 1 )
  {
    strcpy(FileName, "c:\\");
    memset(v11, 0, sizeof(v11));
    strcpy(v9, ".sys");
    memset(v12, 0, 0x32ui64);
    v6 = sub_1400035A0();
    v5 = v12;
    v7 = v12;
    do
    {
      v2 = *v6;
      *v5 = v2;
      ++v6;
      ++v5;
    }
    while ( v2 );
    v3 = &v1[375];
    do
      ++v3;
    while ( *v3 );
    strcpy(v3, v12);
    v4 = &v1[375];
    do
      ++v4;
    while ( *v4 );
    strcpy(v4, v9);
    create_driver_file(FileName);
    install_driver(v12, v12, FileName);
    start_driver();
    return DeleteFileA(FileName);
  }
  else
  {
    printf("Please Use Windows 7 x64!");
    return system("pause");
  }
}

//----- (0000000140006580) ----------------------------------------------------
__int64 sub_140006580()
{
  sub_1400038F0();
  return sub_140003970();
}
// 1400038F0: using guessed type __int64 sub_1400038F0(void);
// 140003970: using guessed type __int64 sub_140003970(void);

//----- (00000001400065A0) ----------------------------------------------------
HANDLE setup()
{
  HMODULE ModuleHandleA; // rax
  HANDLE result; // rax
  _BYTE v2[32]; // [rsp+0h] [rbp-108h] BYREF
  char v3; // [rsp+40h] [rbp-C8h]
  char *v4; // [rsp+48h] [rbp-C0h]
  char *v5; // [rsp+50h] [rbp-B8h]
  char *v6; // [rsp+58h] [rbp-B0h]
  char *v7; // [rsp+60h] [rbp-A8h]
  char *v8; // [rsp+68h] [rbp-A0h]
  char v9[8]; // [rsp+70h] [rbp-98h] BYREF
  int v10; // [rsp+78h] [rbp-90h]
  char v11[46]; // [rsp+7Ch] [rbp-8Ch] BYREF
  char v12[56]; // [rsp+B0h] [rbp-58h] BYREF

  v10 = 6044259;
  memset(v11, 0, sizeof(v11));
  strcpy(v9, ".sys");
  memset(v12, 0, 0x32ui64);
  v7 = sub_1400035A0();
  v6 = v12;
  v8 = v12;
  do
  {
    v3 = *v7;
    *v6 = v3;
    ++v7;
    ++v6;
  }
  while ( v3 );
  v4 = &v2[119];
  do
    ++v4;
  while ( *v4 );
  strcpy(v4, v12);
  v5 = &v2[119];
  do
    ++v5;
  while ( *v5 );
  strcpy(v5, v9);
  ModuleHandleA = GetModuleHandleA("ntdll.dll");
  NtQueryInformationFile = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD))GetProcAddress(
                                                                                             ModuleHandleA,
                                                                                             "NtQueryInformationFile");
  result = CreateFileA("C:\\wmctf.txt", 0x1F01FFu, 3u, 0i64, 2u, 0x80u, 0i64);
  wmctf_file_handle = result;
  return result;
}
// 140090048: using guessed type void *ctx;
// 140090068: using guessed type __int64 (__fastcall *c3)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD);

//----- (0000000140006750) ----------------------------------------------------
__int64 __fastcall prepare_to_compare(char *flag, unsigned int len)
{
  unsigned __int64 i; // [rsp+28h] [rbp-20h]

  for ( i = 0i64; i < len; ++i )
    flag[i] ^= i;
  welcome_str = "Welcome_To_WMCTF";
  flag_ptr = flag;
  flag_len = len;
  return (unsigned __int8)call_driver(1i64, (__int64)&flag_ptr, 24i64);
}
// 140090050: using guessed type _QWORD flag_ptr;

//----- (0000000140006810) ----------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  __int64 flag_len; // [rsp+20h] [rbp-298h]
  __int64 flag_len2; // [rsp+28h] [rbp-290h]
  char flag[608]; // [rsp+40h] [rbp-278h] BYREF

  create_driver();
  setup();
  memset(flag, 0, 0x256ui64);
  if ( !dword_140090038 )
    return 0;
  printf("Please Input Your Flag:\n");
  scanf("%s", flag);
  flag_len = -1i64;
  do
    ++flag_len;
  while ( flag[flag_len] );
  if ( flag_len == 32 )
  {
    flag_len2 = -1i64;
    do
      ++flag_len2;
    while ( flag[flag_len2] );
    prepare_to_compare(flag, flag_len2);
    if ( !memcmp(final, flag_ptr, 0x20ui64) )
      printf("Correct!\n");
    else
      printf("Wrong!\n");
    cleanup_driver();
    system("pause");
    return 0;
  }
  else
  {
    printf("Wrong!\n");
    system("pause");
    return 0;
  }
}
